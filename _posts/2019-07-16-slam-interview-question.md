---
layout: post
title: SLAM面试题总结
date: 2019-06-02
Author: Bowen Nie
categories: 
tags: [slam, 面试题]
comments: true
--- 

## 一、数学基础知识
### 1.1 欧拉角与四元数
#### 1.1.1 欧拉角的万向锁问题
- 在俯仰角为90°时，第一次旋转与第三次旋转将使用同一个轴，使系统失去一个自由度，从三次旋转变为两次旋转，这是个奇异性问题。因为三维旋转是一个三维流形，无法找到不带奇异性的三维向量描述方式。
&nbsp;

#### 1.1.2 四元数如何表示旋转
- 假设某个旋转是绕单位向量$n=[n_x,n_y,n_z]^T$进行了角度为$\theta$的旋转：
$$q=[\cos\frac{\theta}{2},n_x\sin\frac{\theta}{2},n_y\sin\frac{\theta}{2},n_z\sin\frac{\theta}{2}]$$

### 1.2 李群与李代数
#### 1.2.1 指数映射
- 李代数到李群的变换
&nbsp;

#### 1.2.2 李代数求导模型，左乘与右乘的区别
- 扰动模型
- 右乘雅可比只需要对左乘雅可比的自变量取负号即可
&nbsp;

#### 1.2.3 在SLAM中引入李群与李代数的意义
- 李群表示了矩阵的集合，三维旋转矩阵构成SO(3)群，变换矩阵构成SE(3)群，而矩阵的乘法对应着旋转或者变换的复合，这样我们可以用李群来表示三维空间中相机的运动。
- 在李群中，我们使用矩阵来表达一个旋转和平移，这存在冗余的自由度。三维空间的旋转只有三自由度，旋转+平移有六自由度。因此，我们希望寻找一个没有冗余自由度（但是相应的存在奇异性）的表示，也就是李代数so(3)和se(3)。
&nbsp;

### 1.3 非线性优化
#### 1.3.1 雅可比的维度
- 雅可比的维度与求导的形式有关，当e为像素坐标误差（2维），x为相机位姿（6维单目）时，雅可比将是一个2x6的矩阵。
&nbsp;

#### 1.3.2 最大后验与最大似然的概念
- 贝叶斯法则左侧$P(x|z)$通常称为后验概率，右侧的$P(z|x)$称为似然，另一部分$P(x)$i 称为先验。直接求后验分布是困难的，但是可以求一个状态最优估计，使得在该状态下，后验概率最大化(MAP)
$$x^*_{MAP}=argmaxP(x|z)=argmaxP(z|x)P(x)$$
- 求解最大后验概率，相当于最大化似然和先验的乘积。在SLAM问题中，可能我们并不知道相机的位姿大概在哪，这样就没有了先验，问题转化为最大似然估计(MLE):
$$x^*_{MLE}=argmaxP(z|x)$$
- 最大似然估计，可以理解成：“在什么样的状态下，最可能产生现在观测到的数据”
&nbsp;

#### 1.3.3 最小二乘问题如何构建
&nbsp;

#### 1.3.4 非线性优化的常用方法
- 最速下降法（一阶梯度）
- 牛顿法（二阶梯度）
- Gauss-Newton法
- Levenberg-Marquadt法
- Dogleg法
&nbsp;

## 二、SLAM前端
### 2.1 特征点法VO
#### 2.1.1 ORB、SIFT、SURF特征点的区别
- ORB：改进的FAST角点+BRIEF描述子
- SIFT：尺度不变特征转换
- SURF：加速鲁棒特征
- 计算速度：ORB>>SURF>>SIFT
- 旋转鲁棒性：SURF>ORB~SIFT
- 模糊鲁棒性：SURF>ORB~SIFT
- 尺度变换鲁棒性：SURF>SIFT>ORB
&nbsp;

#### 2.1.2 ORB特征点提取的优势
- 计算速度快，实时性好
- ORB 中计算了特征点的主方向，为后续的BRIEF描述子增加了旋转不变特性
-  ORB 添加了尺度和旋转的描述。尺度不变性由构建图像金字塔，并在金字塔的每一层上检测角点来实现。而特征的旋转是由灰度质心法实现
-  BRIEF是一种二进制描述，需要用汉明距离度量，在特征点附近的多次像素比较，得到一个向量描述
-  BRIEF 使用了随机选点的比较，速度非常快，而且由于使用了二进制表达，存储起来也十分方便，适用于实时的图像匹配。
-  原始的 BRIEF描述子不具有旋转不变性的，因此在图像发生旋转时容易丢失。而ORB在FAST特征点提取阶段计算了关键点的方向，所以可以利用方向信息，计算了旋转之后的“SteerBRIEF”特征，使ORB的描述子具有较好的旋转不变性。
&nbsp;

#### 2.1.3 对极几何，什么是对极约束
- 对极约束简洁地给出了两个匹配点的空间位置关系，可以利用对极约束，根据配对点的像素位置，求出E或者F，再从E或者F恢复R和t，这里t具有尺度不确定性，对极约束的公式为：
$$x^T_2t^{\times}Rx_1=0$$
和：
$$p^T_2K^{-T}t^{\times}RK^{-1}p_1=0$$
- 实际中对极几何一般用于单目SLAM的初始化部分，初始化时需要有平移。
&nbsp;

#### 2.1.4 基础矩阵、本质矩阵、单应矩阵
- 基础矩阵$F=K^{-T}EK^{-1}$
- 本质矩阵$E=t^{\times}R$
- 单应矩阵$H=K(R-\frac{tn^T}{d})K^{-1}$
- 单应矩阵描述了两个平面之间的映射关系，若场景中的特征点都落在同一平面上（比如墙，地面等），则可以通过单应性来进行运动估计。
- 单应性在SLAM中具重要意义。当特征点共面，或者相机发生纯旋转的时候，基础矩阵的自由度下降，这就出现了所谓的退化（degenerate）。现实中的数据总包含一些噪声，这时候如果我们继续使用八点法求解基础矩阵，基础矩阵多余出来的自由度将会主要由噪声决定。为了能够避免退化现象造成的影响，通常我们会同时估计基础矩阵 F和单应矩阵H，选择重投影误差比较小的那个作为最终的运动估计矩阵。
&nbsp;

#### 2.1.5 三角测量
- 三角测量是指，通过在两处观察同一个点的夹角，确定该点的距离。
$$s_1x^{\times}_1x_1=0=s_2x^{\times}_1Rx_2+x^{\times}_1t$$
- 三角测量需要已知R和t，通常由于噪声的存在，估计的R和t不一定严格使该式值为0，所以常求最小二乘解而非零解。
- 三角测量是由平移得到的，有平移才会有对极几何中的三角形，才谈的上三角测量。因此，纯旋转是无法使用三角测量的，因为对极约束将永远满足。在平移存在的情况下，我们还要关心三角测量的不确定性，这会引出一个三角测量的矛盾。
- 要增加三角化的精度，其一是提高特征点的提取精度，也就是提高图像分辨率——但这会导致图像变大，提高计算成本。另一方式是使平移量增大。但是，平移量增大，会导致图像的外观发生明显的变化，比如箱子原先被挡住的侧面显示出来了，比如反射光发生变化了，等等。外观变化会使得特征提取与匹配变得困难。总而言之，在增大平移，会导致匹配失效；而平移太小，则三角化精度不够——这就是三角化的矛盾。
&nbsp;

#### 2.1.6 PnP方法
- PnP是求解3D到2D点对运动的方法，如果两张图像中，其中一张的特征点3D位置已知，那么最少只需要3个点对（需要至少一个额外点验证结果）就可以估计相机运动。
- 在双目或者RGB-D的VO中，我们可以直接使用PnP，单目VO需要先初始化。
- PnP问题的主要求解方法有代数的P3P、DLT、EPnP，优化的BA等。
&nbsp;

#### 2.1.7 ICP方法
- Iterative Closest Point迭代最近点，用于3D-3D的匹配，在这样的位姿估计问题中不涉及到相机模型。
- ICP问题的主要求解方法有代数的SVD，优化的BA等。
- ICP问题存在唯一解或无穷多解的情况，在唯一解的情况下，只要我们能找到极小值解，那么这个极小值就是全局最优值，意味着ICP求解可以任意选定初始值。
&nbsp;

#### 2.1.8 相机模型与相机标定
- 单目相机
- 张正友标定法
&nbsp;

#### 2.1.9 相机空间尺度的确定
- 三角测量
- 双目$z=\frac{fb}{d}$
&nbsp;

## 三、SLAM后端
### 3.1 滤波与优化
#### 3.1.1 滤波与优化的原理和区别
- 滤波基于马尔可夫假设，属于递推式方法，认为k时刻的状态只与k-1时刻有关。这样类似在VO中只考虑相邻两帧的关系，如果上一帧开始出现误差，那么下一帧的先验就带有误差，这个误差在后续递推中无法消除，会造成误差的不断积累，而且滤波方法也很难处理回环问题。
- 优化属于批量式方法，考虑k时刻状态与之前所有时刻状态的关系。优化方法使用了更多信息，也就需要更多的计算，在更新频率很高的系统中，实时性不如滤波器。
- 滤波方法如EKF，认为在一点处的线性化近似，在后验概率处仍是有效的。而实际上，当离开这个工作点较远时，一阶泰勒展开并不一定能近似整个函数这取决于运动模型和观测模型的非线性情况。如果它们有强烈的非线性，那线性近似就只在很小范围内成立，不能认为在很远的地方仍能用线性来近似。这就是EKF的非线性误差，是它的主要问题所在，不能保证有全局最优解。
- 在优化问题中，尽管我们也做一阶（最速下降）或二阶（G-N或L-M）的近似，但每迭代一次，状态估计发生改变之后，我们会重新对新的估计点做泰勒展开，而不像EKF那样只在固定点上做一次泰勒展开。这就导致优化方法适用范围更广，则在状态变化较大时亦能适用。
- 从程序实现上来说，EKF需要存储状态量的均值和方差，并对它们进行维护和更新。如果把路标也放进状态的话，由于视觉SLAM中路标数量很大，这个存储量是相当可观的，且与状态量呈平方增长（因为要存储协方差矩阵）。因此，EKF-SLAM普遍被认为不可适用于大型场景。
&nbsp;

### 3.2 滤波问题
#### 3.2.1 粒子滤波的原理
- 粒子滤波器是一种使用蒙特卡罗方法的递归滤波器，透过一组具有权重的随机样本(称为粒子)来表示随机事件的后验机率，从含有噪声或不完整的观测序列，估计出动态系统的状态，粒子滤波器可以运用在任何状态空间的模型上。
- 粒子滤波器是卡尔曼滤波器的一般化方法，卡尔曼滤波器建立在线性的状态空间和高斯分布的噪声上；而粒子滤波器的状态空间模型可以是非线性，且噪声分布可以是任何型式。
&nbsp;

#### 3.2.2 如何构建粒子滤波问题
&nbsp;

### 3.3 图优化问题
#### 3.3.1 Bundle Adjustment的原理
- 所谓Bundle Adjustment，是指从视觉重建中提炼出最优的3D模型和相机内外参数。从每一个特征点反射出来的几束光线（bundles of light rays），在我们把相机姿态和特征点空间位置做出最优的调整（adjustment）之和，最后收束到相机光心的这个过程，简称BA。
&nbsp;

#### 3.3.2 g2o如何构建图优化问题
1. 定义顶点和边的类型，误差计算函数
2. 构建图
- 添加顶点
- 添加边，设置连接的顶点，观测数值，信息矩阵（协方差矩阵的逆，常用单位矩阵）
3. 选择优化算法
- 选择一个线性方程求解器，从PCG、CSparse、Choldmod中选，实际则来自g2o/solvers文件夹中定义的方法。
- 选择一个BlockSolver。
- 选择一个迭代策略，从GN\LM\Dogleg中选。
4. 调用g2o进行优化，返回结果
&nbsp;

#### 3.3.3 稀疏性与边缘化
1. 大多数SLAM系统将集束调整作用于稀疏抽取的关键帧上。在这种情况下，除了相邻的关键帧，以及循环回路两端的关键帧外，其他关键帧之间往往并没有公共点。于是，舒尔补方程的系数矩阵S往往十分稀疏。利用这一特性，我们可以选用预处理共轭梯度（PCG）算法高效求解舒尔补方程。

## 四、回环与建图
### 4.1 回环检测的常用方法
1. 准确率：算法提取的所有回环中，确实是真实回环的概率。
2. 召回率：所有真实回环中，被正确检测出来的概率。

#### 4.1.1 词袋模型
- 词袋模型的目的是用“图像上有哪几种特征”来描述一个图像。
- 具体步骤：
1. 确定“人、车、狗”等概念，对应BoW中的“单词”（Word），许多单词放在一起，组成了“字典”。
2. 确定一张图像中，出现了哪些在字典中定义的概念——我们用单词出现的情况（或直方图）描述整张图像。这就把一个图像转换成了一个向量描述，该描述向量只关注“是否出现”，不管“在哪儿出现”，所以与顺序无关。
3. 比较上一步中描述的相似程度。
&nbsp;

#### 4.1.2 特征提取与聚类
- 字典生成问题类似于一个聚类问题
- K叉树字典，训练字典时，逐层使用K-means聚类。根据已知特征查找单词时，亦可逐层比对，找到对应的单词。
&nbsp;

#### 4.1.3 相似度计算
- TF-IDF
- TF：某单词在一个图像中经常出现，它的区分度就高。
- IDF：某单词在字典中出现的频率越低，则分类图像时区分度越高。

#### 4.1.4 回环的验证
- 时间一致性检测：建立回环的缓存机制，认为单次检测到的回环并不足以构成良好的约束，而在一段时间内一直检测到的回环，才认为是正确的回环。
- 空间一致性检测：对回环检测到的两个帧进行特征匹配，估计相机的运动，然后把运动放到之前的Pose Graph中，检查与之前的估计是否有很大的出入。
- 用于回环检测的关键帧的选取，一般要稀疏一些，彼此之间不太相同，又能覆盖整个环境。
- 如果第1帧和第n帧构成回环，那么可能n+1，n+2帧也与第1帧构成回环，这时候多余的信息用处不大。可以把相近的回环聚成一类，使算法不要反复检测同一类回环。

## 五、SLAM实现
### 5.1 VO的实现

&nbsp;

### 5.2 ORB_SLAM2的解析
![image_1d0lm7kd21jmcbqqsvu17ko6t79.png-143.6kB][1]
&nbsp;

### 5.3 SLAM的发展
#### 5.3.1 SLAM的发展阶段
1. 滤波阶段：局部信息融合
2. 图优化阶段：全局一致性优化
3. 增量平滑阶段：用贝叶斯树维护一个动态更新的数，兼具滤波的速度和图优化的精度

## 六、IMU相关问题
### 6.1 IMU原理
#### 6.1.1 IMU的运动模型
- IMU的状态量通常表示为：
$$X_{IMU}=[^I_G\overline{q}^T\quad b_g^T\quad ^Gv^T_I\quad b_a^T\quad ^Gp^T_I]$$
- IMU的姿态由旋转量$^I_G\overline{q}$（$G$到$I$，单位四元数表示）和平移量$^Gp_I$表示。${I}$表示IMU坐标系，$G$表示参考坐标系。$^Gv_I$表示IMU在$G$下的平移速度。$b_a$和$b_g$表示加速度计和陀螺仪（角速度计）的bias。
- 下图所示为IMU的运动模型
![微信图片_20180809154624.png-6.7kB][2]
&nbsp;

#### 6.1.2 IMU的观测模型
- IMU的观测模型包含两类的传感器误差，一类是波动激烈的测量白噪声，一类是变化缓慢的bias。可以理解为，测量噪声是AD转换器件引起的外部噪声，bias是传感器内部机械、温度等各种物理因素产生的传感器内部误差的综合参数。
- 高斯白噪声，概率上服从高斯分布，一阶矩（均值）是常数，二阶矩（方差）不相关，即不同时刻的信号是不相关的噪声。或者说噪声的瞬时值服从高斯分布（高斯），功率密度谱又是均匀分布的（白噪声）。
&nbsp;

- 每一时刻都是上一个采样时刻加上一个高斯白噪声得到的，犹如一个游走的粒子，踏出的下一步永远是随机的。
- 随机游走是维纳过程（高斯白噪声的积分）的离散形式，每一次更新位置都会叠加一个新的高斯白噪声，IMU的bias建模为随机游走噪声。随机游走噪声的均值是初值的均值，方差是初值的方差乘以间隔时间。
&nbsp;

- 地心地固坐标系ECEF，以地心为坐标原点，向北为z轴，x-y平面为赤道平面，x轴指向经纬度(0,0)点。ECEF固联在地球上，跟随地球自转，是非惯性系。MSCKF一代使用ECEF为参考坐标系。
- 地心惯性坐标系ECI，以地心为坐标原点，向北为z轴，x-y平面为赤道平面，x轴指向春分点。ECI不跟随地球自转，视为惯性系。MSCKF二代使用ECI为参考坐标系。
- 体坐标系Body Frame，原点在导航体的质心上，固联在导航体上，用来表示导航体的姿态。
- 以ECI为参考坐标系的观测模型：
$$\omega_m=\omega+R(^I_G\overline{q})\omega+b_g+n_g$$
$$a_m=R(^I_G\overline{q})(^Ga-^Gg)+b_a+n_a$$
- 在移动机器人领域ECI用的多一些。
&nbsp;

#### 6.1.3 滤波方法
- IMU的数据频率很高，采用滤波方法可以减少计算量，提高实时性。
&nbsp;

### 6.2 融合定位问题
#### 6.2.1. VIO的耦合方式
1. 松耦合：IMU和相机分别进行自身的运动估计，然后对它们的位姿估计结果进行融合。
2. 紧耦合：把IMU的状态与相机的状态合并在一起，共同构建运动方程和观测方程，然后进行状态估计。
&nbsp;

#### 6.2.2 VIO的预积分
- 预积分给出了一种比较优雅的，在SO(3)流形上处理IMU运动的方法，并给出了实现代码（gtsam中）。
- 由IMU的观测模型，考虑VIO的紧耦合方案，通常选择位姿、速度、零偏这几个量组成待估计的状态变量，共15维：
![v2-3750bdab85da976875a5d4e6101e86ac_hd.jpg-13.8kB][3]
&nbsp;

#### 6.2.2 VIO如何确定空间尺度

&nbsp;

#### 6.2.3 MSCKF
- Multi-State Constraint KF

&nbsp;

#### 6.2.4 IMU与GNSS的紧耦合

&nbsp;

## 七、实际工程问题
### 7.1 考虑实际场景
- 举例：机器人进出电梯场景
1. 考虑点、线结合的特征提取，如果可以提取特征线段，就可以获得电梯轮廓，同时，双目相机可通过视差判断机器人此时实际面对的墙面深度，从而判断电梯门是否打开。这里可能可以通过RGBD相机或者激光雷达辅助进行深度判断，保证更高的精度。
&nbsp;

### 7.2 关键帧怎么选
![image_1d0ttu2en16b711ei5jgq7gtqm.png-60.7kB][4]

![image_1d0tuudbgv7h1qu515bj1qi6fcv1j.png-95.2kB][5]

## 八、编程问题
### 8.1 C++问题
1. 面向对象，类与结构
2. 静态类型static
3. 指针问题
&nbsp;

### 8.2 算法题
1. 点在三角形内
2. 排序算法
3. 搜索算法


  [1]: http://static.zybuluo.com/hlm12348765/1bc6xefw5vdm31fipux77tco/image_1d0lm7kd21jmcbqqsvu17ko6t79.png
  [2]: http://static.zybuluo.com/hlm12348765/zq1upz6ert6154w2zpgtujk7/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180809154624.png
  [3]: http://static.zybuluo.com/hlm12348765/47wurebpvsqcgfu8w2ixu696/v2-3750bdab85da976875a5d4e6101e86ac_hd.jpg
  [4]: http://static.zybuluo.com/hlm12348765/lxkc8nozqjivrey78z37cs6b/image_1d0ttu2en16b711ei5jgq7gtqm.png
  [5]: http://static.zybuluo.com/hlm12348765/hdz42x6gz637jfe15mt475zp/image_1d0tuudbgv7h1qu515bj1qi6fcv1j.png